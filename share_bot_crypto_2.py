# ! py
# Bot tradingview 
# Copyright by @Truongchinh304

import requests, time, telebot, os, json 
from telebot import types 
from datetime import datetime, timedelta
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

TOKEN_API_BOT = 'THAY_API_BOT'
URL_API_BINANCE= 'https://api.binance.com/api/v3'
bot = telebot.TeleBot(TOKEN_API_BOT)
print("Bot ƒëang ch·ªù d·ªØ li·ªáu Binance ...\n")

# H√†m l·∫•y t·ª∑ gi√° usd ƒë·ªïi sang vnd 
def lay_ty_gia_vnd():
    response = requests.get('https://api.exchangerate-api.com/v4/latest/USD')  # API t·ª∑ gi√° ti·ªÅn t·ªá
    data = response.json()
    return data['rates']['VND']
            
# H√†m l·∫•y danh s√°ch c√°c ƒë·ªìng dvdhvcdl
def lay_danh_sach_crypto():
    response = requests.get(f'{URL_API_BINANCE}/exchangeInfo')
    data = response.json()
    danh_sach = [s['symbol'] for s in data['symbols'] if s['quoteAsset'] == 'USDT']
    return danh_sach 

# H√†m l·∫•y th√¥ng tin chi ti·∫øt c·ªßa ƒë·ªìng crypto
def lay_thong_tin_crypto(ten_crypto):
    response = requests.get(f'{URL_API_BINANCE}/ticker/24hr', params={'symbol': ten_crypto})
    data = response.json()
    return data

def lay_thong_tin_gioi_han_crypto(ten_crypto, timestamp_thoi_gian_muon_lay, timestamp_hien_tai):
    response = requests.get(f'{URL_API_BINANCE}/klines', params={
        'symbol': ten_crypto,
        'interval': '1m',  
        'startTime': timestamp_thoi_gian_muon_lay,
        'endTime': timestamp_hien_tai,
    })
    datas = response.json()
    return datas
        
@bot.message_handler(commands=['start'])
def start(message):
    user_name = message.from_user.username
    if not user_name :
        full_name = message.from_user.first_name + " " + message.from_user.last_name
    else:    
        full_name = user_name
    huong_dan_su_dung = telebot.types.InlineKeyboardButton("üßæ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng", callback_data="hdsd")
    keyboard = telebot.types.InlineKeyboardMarkup()
    keyboard.row(huong_dan_su_dung)
    bot.send_message(message.chat.id, f"<b>üôã Ch√†o m·ª´ng {full_name} ƒë·∫øn v·ªõi Pperry trading bot\nNh·∫•p v√†o n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem l·ªánh s·ª≠ d·ª•ng.</b>", parse_mode="HTML",reply_markup=keyboard)
    
# L·ªánh /list
@bot.message_handler(commands=['list'])
def gui_danh_sach_crypto(message):
    danh_sach = lay_danh_sach_crypto()
    noi_dung = 'Danh s√°ch c√°c ƒë·ªìng crypto:\n' + '\n'.join(danh_sach)
    file_path_list_crypto = "/sdcard/download/codingpython/list_crypto.txt"
    if len(noi_dung) > 4096:
        with open(file_path_list_crypto, "w", encoding = "utf-8") as file:
            file.write(noi_dung)
        with open(file_path_list_crypto, "rb") as file:  
            bot.send_document(message.chat.id, file)
        os.remove(file_path_list_crypto)  

# H√†m h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng         
def huong_dan_su_dung(message):
    huong_dan_su_dung = (
        "<b>H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG\n"
        "L·ªánh 1: /list (xem danh s√°ch c√°c ƒë·ªìng crypto)\n"
        "L·ªánh 2: /tpsl [t√™n coin] [gi√° ch·ªët l·ªùi (TP)] [gi√° ch·ªët l·ªó (SL)] (xem th√¥ng tin coin ƒë√≥)\n"
        "L·ªánh 3: /stop (ng∆∞ng theo d√µi l·ªánh tpsl ƒëang ch·∫°y)\n"
        "L·ªánh 4: /gpi [t√™n coin] [kho·∫£ng th·ªùi gian mu·ªën l·∫•y th√¥ng tin (ph√∫t)]\n"
        "L·ªánh 5: /about (xem th√¥ng tin account v√† bot)"
        "L∆∞u √Ω:\n"
        "Khi 1 l·ªánh ƒëang ch·∫°y m√† mu·ªën thay TP/SL th√¨ ch·ªâ c·∫ßn nh·∫≠p nh∆∞ l·ªánh v√† thay ƒë·ªïi TP/SL mu·ªën thay\n"
        "L·ªánh s·∫Ω ƒë∆∞·ª£c update gi√° m·ªõi sau m·ªói 3 gi√¢y\n"
        "N·∫øu nh·∫≠p l·ªánh m·ªõi b·∫±ng coin kh√°c th√¨ th√¥ng tin coin c≈© s·∫Ω d·ª´ng.</b>"
    )    
    bot.send_message(message.chat.id, huong_dan_su_dung, parse_mode = "HTML")

# L·ªánh /stop
@bot.message_handler(commands=['stop'])
def dung_theo_doi(message):
    global trang_thai_lenh
    if trang_thai_lenh['dang_chay']:
        trang_thai_lenh['dang_chay'] = False  # ƒê·∫∑t tr·∫°ng th√°i d·ª´ng
        bot.send_message(message.chat.id, f"<b>ƒê√£ d·ª´ng theo d√µi {trang_thai_lenh['ten_crypto']}</b>", parse_mode="HTML")
    else:
        bot.send_message(message.chat.id, "<b>Kh√¥ng c√≥ l·ªánh n√†o ƒëang ch·∫°y</b>", parse_mode="HTML")

# L·ªánh /about xem th√¥ng tin 
@bot.message_handler(commands=['about'])
def vai_dieu_muon_noi(message):  
    is_bot = message.from_user.is_bot
    if is_bot:
        is_bot_ans = "True"
    else:
        is_bot_ans = "False"
    user_id = message.from_user.id 
    user_first_name = message.from_user.first_name 
    user_last_name = message.from_user.last_name 
    user_language = message.from_user.language_code 
    user_name = message.from_user.username 
    full_name = user_first_name + " " + user_last_name    
    infor = (
        f"<b>üë§ Th√¥ng tin b·∫°n\n"
        f" ‚îú ID: {user_id}\n"
        f" ‚îú L√† bot: {is_bot_ans}\n"
        f" ‚îú T√™n ƒë·∫ßu: {user_first_name}\n"
        f" ‚îú T√™n cu·ªëi: {user_last_name}\n"
        f" ‚îú T√™n ng∆∞·ªùi d√πng: <a href='https://t.me/{user_name}'>{user_name}</a>\n"
        f" ‚îú T√™n ƒë·∫ßy ƒë·ªß: {full_name}\n"
        f" ‚îî M√£ ng√¥n ng·ªØ: {user_language} (-)</b>"
    )             
    bot.send_message(message.chat.id, f"<b>Ch√†o {full_name.capitalize()} t√¥i l√† Pperry Tradingview Bot. Nhi·ªám v·ª• cu·∫£ t√¥i l√† g·ª≠i t√≠n hi·ªáu t·ª´ s√†n m·ªói 3 gi√¢y. B√™n c·∫°nh ƒë√≥ t√¥i c√≤n c√≥ th·ªÉ gi√∫p b·∫°n xem h·∫øt th√¥ng tin t·∫•t c·∫£ ƒë·ªìng Crypto hi·ªán nay tr√™n s√†n 1 c√°ch nhanh ch√≥ng.\n\nXem bi·ªÉu ƒë·ªì t·∫°i <a href='https://vn.tradingview.com/'>TradingView</a>\n\nV√†i ƒëi·ªÅu l∆∞u √Ω:\nH·∫°n ch·∫ø xem c√°c ƒë·ªìng c√≥ gi√° tr·ªã qu√° nh·ªè s·∫Ω g√¢y l·ªói.Gi√° tr·ªã khi xem (Vnd) s·∫Ω kh√¥ng ch√≠nh x√°c v√¨ 1 v√†i l√Ω do\n\nS·ª≠ d·ª•ng n·∫øu c√≥ l·ªói h√£y nh·∫Øn cho <a href='https://t.me/Truongchinh304'>Admin</a>\n\nD∆∞·ªõi ƒë√¢y l√† th√¥ng tin ƒë·∫ßy ƒë·ªß cu·∫£ b·∫°n.</b>\n{infor}\n", parse_mode="HTML")
    
data_storage = {}
@bot.callback_query_handler(func=lambda call: True)
def handle_callback_query_game(call):
    if call.data == "hdsd":
        huong_dan_su_dung(call.message)
    elif call.data.startswith("gvf:"):
        unique_id = call.data.split(":")[1]
        # L·∫•y d·ªØ li·ªáu t·ª´ t·ª´ ƒëi·ªÉn
        if unique_id in data_storage:
            data = data_storage[unique_id]
            ten_crypto = data["ten_crypto"]
            khoang_thoi_gian = data["khoang_thoi_gian"]
            all_noi_dung = data["all_noi_dung"]
            ghi_noi_dung_vao_file(ten_crypto, khoang_thoi_gian, all_noi_dung, call.message)
            # X√≥a d·ªØ li·ªáu kh·ªèi t·ª´ ƒëi·ªÉn sau khi s·ª≠ d·ª•ng
            del data_storage[unique_id]
    
trang_thai_lenh = {
    'ten_crypto': None,
    'nguong_chot_loi': None,
    'nguong_chot_lo': None,
    'nguong_chot_loi_vnd': None,
    'nguong_chot_lo_vnd': None,
    'dang_chay': False,
    'id_tin_nhan': None  # ID c·ªßa tin nh·∫Øn ƒë·ªÉ ki·ªÉm so√°t v√≤ng l·∫∑p.
}

# H√†m t√≠nh trung b√¨nh 5 gi√° g·∫ßn nh·∫•t 
def tinh_trung_binh_gia_gan_nhat(ten_crypto):
    thoi_gian_hien_tai = datetime.now()
    thoi_gian_5_phut_truoc = thoi_gian_hien_tai - timedelta(minutes=5)
    timestamp_5_phut_truoc = int(thoi_gian_5_phut_truoc.timestamp() * 1000)
    timestamp_hien_tai = int(thoi_gian_hien_tai.timestamp() * 1000)
    response = requests.get(f'{URL_API_BINANCE}/klines', params={
        'symbol': ten_crypto,
        'interval': '1m',  
        'startTime': timestamp_5_phut_truoc,
        'endTime': timestamp_hien_tai,
        'limit': 5 # L·∫•y 5 gi√° g·∫ßn nh·∫•t 
    })
    datas = response.json()
    if datas:
        gia_dong_cua = [float(data[4]) for data in datas[-5:]] 
        gia_trung_binh = sum(gia_dong_cua) / 5  
        return gia_trung_binh 

# H√†m xem kh·ªëi l∆∞·ª£ng gi√° 24h v√† tpsl     
@bot.message_handler(commands=['tpsl'])
def gui_thong_tin_crypto_usd(message):
    global trang_thai_lenh
    try:
        ty_gia_vnd = lay_ty_gia_vnd()
        nhap_thong_tin = message.text.split()
        
        if len(nhap_thong_tin) != 4:
            bot.send_message(message.chat.id, "<b>Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng: /tpsl [t√™n coin] [gi√°_ch·ªët_l·ªùi (TP)] [gi√°_ch·ªët_l·ªó (SL)]</b>", parse_mode = "HTML")
            return
        ten_crypto = nhap_thong_tin[1].upper() 
        nguong_chot_loi = float(nhap_thong_tin[2])  # Gi√° ch·ªët l·ªùi
        nguong_chot_lo = float(nhap_thong_tin[3])  # Gi√° ch·ªët l·ªó
        nguong_chot_loi_vnd = nguong_chot_loi * ty_gia_vnd
        nguong_chot_lo_vnd = nguong_chot_lo * ty_gia_vnd
        # Ki·ªÉm tra n·∫øu l·ªánh ƒëang ch·∫°y
        if trang_thai_lenh['dang_chay']:
            if trang_thai_lenh['ten_crypto'] == ten_crypto:
                trang_thai_lenh['nguong_chot_loi'] = nguong_chot_loi
                trang_thai_lenh['nguong_chot_lo'] = nguong_chot_lo
                trang_thai_lenh['nguong_chot_loi_vnd'] = nguong_chot_loi_vnd
                trang_thai_lenh['nguong_chot_lo_vnd'] = nguong_chot_lo_vnd
                bot.send_message(message.chat.id, f"<b>ƒê√£ c·∫≠p nh·∫≠t TP/SL m·ªõi cho {ten_crypto} USD\n[{nguong_chot_loi:,.6f} - {nguong_chot_lo:,.6f}]</b>", parse_mode = "HTML")
                bot.send_message(message.chat.id, f"<b>ƒê√£ c·∫≠p nh·∫≠t TP/SL m·ªõi cho {ten_crypto} VND\n[{nguong_chot_loi_vnd:,.2f} - {nguong_chot_loi_vnd:,.2f}]</b>", parse_mode = "HTML")
                return
            else:
                trang_thai_lenh['dang_chay'] = False
                bot.send_message(message.chat.id, f"<b>Ng∆∞ng theo d√µi {trang_thai_lenh['ten_crypto']} v√† b·∫Øt ƒë·∫ßu theo d√µi {ten_crypto}</b>", parse_mode = "HTML")
        # C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªánh m·ªõi
        trang_thai_lenh['ten_crypto'] = ten_crypto
        trang_thai_lenh['nguong_chot_loi'] = nguong_chot_loi
        trang_thai_lenh['nguong_chot_lo'] = nguong_chot_lo
        trang_thai_lenh['nguong_chot_loi_vnd'] = nguong_chot_loi_vnd
        trang_thai_lenh['nguong_chot_lo_vnd'] = nguong_chot_lo_vnd
        trang_thai_lenh['dang_chay'] = True
        danh_sach = lay_danh_sach_crypto()
        if ten_crypto not in danh_sach:
            bot.send_message(message.chat.id, "<b>ƒê·ªìng crypto kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i</b>", parse_mode = "HTML")
            return
        thong_tin = lay_thong_tin_crypto(ten_crypto)
        ngay_thoi_gian = datetime.now().strftime("%d/%m/%Y - %H:%M:%S")
        ngay = datetime.now().strftime("%d-%m-%Y")
        # T·ª∑ gi√° USD g·ªëc 
        gia_hien_tai = float(thong_tin['lastPrice'])
        gia_truoc_do = gia_hien_tai  # Gi√° tr∆∞·ªõc ƒë√≥ b·∫Øt ƒë·∫ßu b·∫±ng gi√° hi·ªán t·∫°i ban ƒë·∫ßu
        gia_tang_giam = float(thong_tin['priceChange'])
        gia_trung_binh = float(thong_tin['weightedAvgPrice'])
        gia_mo_cua = float(thong_tin['openPrice'])
        gia_dong_cua = float(thong_tin['prevClosePrice'])
        # T·ª∑ gi√° USD chuy·ªÉn sang VND
        gia_hien_tai_vnd = gia_hien_tai * ty_gia_vnd
        gia_truoc_do_vnd = gia_truoc_do * ty_gia_vnd
        gia_tang_giam_vnd = gia_tang_giam * ty_gia_vnd
        gia_trung_binh_vnd = gia_trung_binh * ty_gia_vnd
        gia_mo_cua_vnd = gia_mo_cua * ty_gia_vnd 
        gia_dong_cua_vnd = gia_dong_cua * ty_gia_vnd
        noi_dung = (
            f"<b>üìã Th√¥ng tin coin {ten_crypto.replace('USDT','')}</b>\n"
            f"<b>‚è±Ô∏è Th·ªùi gian:</b> {ngay_thoi_gian}\n\n"
            f"<b>üí≤ ƒê∆°n v·ªã ti·ªÅn t·ªá:</b> USD\n"
            f"<b>üí∏ Gi√° hi·ªán t·∫°i:</b> {gia_hien_tai:,.5f}\n"
            f"<b>‚è≥ Gi√° tr∆∞·ªõc ƒë√≥:</b> {gia_truoc_do:,.5f}\n"
            f"<b>üìà Gi√° tƒÉng/gi·∫£m:</b> {gia_tang_giam:,.5f}\n"
            f"<b>üîì Gi√° m·ªü c·ª≠a:</b> {gia_mo_cua:,.5f}\n"
            f"<b>üõ°Ô∏è Gi√° ƒë√≥ng c·ª≠a:</b> {gia_dong_cua:,.5f}\n"
            f"<b>üìä Gi√° trung b√¨nh:</b> {gia_trung_binh:,.5f}\n\n"
            f"<b>üí≤ ƒê∆°n v·ªã ti·ªÅn:</b> VND\n"
            f"<b>üí∏ Gi√° hi·ªán t·∫°i:</b> {gia_hien_tai_vnd:,.2f}\n"
            f"<b>‚è≥ Gi√° tr∆∞·ªõc ƒë√≥:</b> {gia_truoc_do_vnd:,.2f}\n"
            f"<b>üìà Gi√° tƒÉng/gi·∫£m:</b> {gia_tang_giam_vnd:,.2f}\n"
            f"<b>üîì Gi√° m·ªü c·ª≠a:</b> {gia_mo_cua_vnd:,.2f}\n"
            f"<b>üõ°Ô∏è Gi√° ƒë√≥ng c·ª≠a:</b> {gia_dong_cua_vnd:,.2f}\n"
            f"<b>üìä Gi√° trung b√¨nh:</b> {gia_trung_binh_vnd:,.2f}\n\n"
            f"<b>üìé TP/SL:</b> [{nguong_chot_loi:,.2f} - {nguong_chot_lo:,.2f}]\n"
            f"<b>üìé TP/SL:</b> [{nguong_chot_loi_vnd:,.2f} - {nguong_chot_lo_vnd:,.2f}]"
        )
        msg = bot.send_message(message.chat.id, noi_dung, parse_mode = "HTML")
        trang_thai_lenh['id_tin_nhan'] = msg.message_id  # L∆∞u l·∫°i ID c·ªßa tin nh·∫Øn
        # C·∫≠p nh·∫≠t tin nh·∫Øn sau m·ªói 3 gi√¢y
        da_chot_loi = False 
        da_chot_lo = False 
        current_content = ""
        while trang_thai_lenh['dang_chay'] and trang_thai_lenh['id_tin_nhan'] == msg.message_id:
            ty_gia_vnd = lay_ty_gia_vnd()
            thong_tin = lay_thong_tin_crypto(ten_crypto)
            ngay_thoi_gian = datetime.now().strftime("%d/%m/%Y - %H:%M:%S")
            thoi_gian = datetime.now().strftime("%H:%M:%S")
            so_luong_giao_dich = int(thong_tin['count'])
            gia_trung_binh_gan_nhat = tinh_trung_binh_gia_gan_nhat(ten_crypto)   
            # T·ª∑ gi√° USD
            gia_hien_tai = float(thong_tin['lastPrice'])
            gia_thay_doi = float(thong_tin['priceChange'])
            gia_trung_binh = float(thong_tin['weightedAvgPrice'])
            gia_mo_cua = float(thong_tin['openPrice'])
            gia_dong_cua = float(thong_tin['prevClosePrice'])
            gia_cao_nhat = float(thong_tin['highPrice'])  
            gia_thap_nhat = float(thong_tin['lowPrice'])  
            gia_ban = float(thong_tin['bidPrice'])
            gia_mua = float(thong_tin['askPrice'])
            khoi_luong_giao_dich = float(thong_tin['volume'])
            khoi_luong_ti_gia = float(thong_tin['quoteVolume'])
            phan_tram_gia_thay_doi = float(thong_tin['priceChangePercent'])
            nguong_chot_loi = trang_thai_lenh['nguong_chot_loi']
            nguong_chot_lo = trang_thai_lenh['nguong_chot_lo']
            # T·ª∑ gi√° VND
            gia_hien_tai_vnd = gia_hien_tai * ty_gia_vnd
            gia_truoc_do_vnd = gia_truoc_do * ty_gia_vnd
            gia_thay_doi_vnd = gia_thay_doi * ty_gia_vnd
            gia_trung_binh_vnd = gia_trung_binh * ty_gia_vnd
            gia_mo_cua_vnd = gia_mo_cua * ty_gia_vnd 
            gia_dong_cua_vnd = gia_dong_cua * ty_gia_vnd
            gia_cao_nhat_vnd = gia_cao_nhat * ty_gia_vnd
            gia_thap_nhat_vnd = gia_thap_nhat * ty_gia_vnd 
            gia_ban_vnd = gia_ban * ty_gia_vnd
            gia_mua_vnd = gia_mua * ty_gia_vnd 
            khoi_luong_giao_dich_vnd = khoi_luong_giao_dich * ty_gia_vnd
            khoi_luong_ti_gia_vnd = khoi_luong_ti_gia * ty_gia_vnd
            phan_tram_gia_thay_doi_vnd = (1 - (gia_hien_tai_vnd / gia_mo_cua_vnd)) * 100
            nguong_chot_loi_vnd = nguong_chot_loi * ty_gia_vnd
            nguong_chot_lo_vnd = nguong_chot_lo * ty_gia_vnd
            # ƒê·∫∑t ƒëi·ªÅu ki·ªán ƒë·ªÉ edit tin nh·∫Øn m·ªõi 
            if gia_hien_tai != gia_truoc_do:
                noi_dung = (
                    f"<b>üìã <u>TH√îNG TIN COIN {ten_crypto.replace('USDT','')}</u></b>\n"
                    f"<b>üõü <u>S·ªë l∆∞·ª£ng giao d·ªãch:</u></b> {so_luong_giao_dich}\n\n"
                    f"<b>‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚≠ì</b>\n"
                    f"<b>‚îú‚û§</b><u><b>üí≤ ƒê∆°n v·ªã ti·ªÅn t·ªá: USD (USDollar)</b></u>\n"
                    f"<b>‚îú‚û§üí∏ Gi√° hi·ªán t·∫°i:</b> {gia_hien_tai:,.6f}\n"
                    f"<b>‚îú‚û§‚è≥ Gi√° tr∆∞·ªõc ƒë√≥:</b> {gia_truoc_do:,.6f}\n"
                    f"<b>‚îú‚û§üìà Gi√° tƒÉng/gi·∫£m:</b> {gia_thay_doi:,.6f}\n"
                    f"<b>‚îú‚û§üîé Ph·∫ßn trƒÉm tƒÉng/gi·∫£m:</b> {phan_tram_gia_thay_doi:.2f}%\n"
                    f"<b>‚îú‚û§üîì Gi√° m·ªü c·ª≠a:</b> {gia_mo_cua:,.6f}\n"
                    f"<b>‚îú‚û§üõ°Ô∏è Gi√° ƒë√≥ng c·ª≠a:</b> {gia_dong_cua:,.6f}\n"
                    f"<b>‚îú‚û§üìå Gi√° cao nh·∫•t:</b> {gia_cao_nhat:,.6f}\n"
                    f"<b>‚îú‚û§üìå Gi√° th·∫•p nh·∫•t:</b> {gia_thap_nhat:,.6f}\n"
                    f"<b>‚îú‚û§üìå Gi√° trung b√¨nh:</b> {gia_trung_binh:,.6f}\n"
                    f"<b>‚îú‚û§üõí Gi√° mua:</b> {gia_mua:,.6f}\n"
                    f"<b>‚îú‚û§üõçÔ∏è Gi√° b√°n:</b> {gia_ban:,.6f}\n"
                    f"<b>‚îú‚û§‚öñÔ∏è Kh·ªëi l∆∞·ª£ng giao d·ªãch:</b> {khoi_luong_giao_dich:,.2f}\n"
                    f"<b>‚îú‚û§‚öñÔ∏è Kh·ªëi l∆∞·ª£ng t·ªâ gi√°:</b> {khoi_luong_ti_gia:,.2f}\n"
                    f"<b>‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>\n"
                    f"<b>‚îú‚û§</b>           {ngay_thoi_gian}\n"
                    f"<b>‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>\n"
                    f"<b>‚îú‚û§</b><u><b>üí≤ ƒê∆°n v·ªã ti·ªÅn t·ªá: VND (VietNamDong)</b></u>\n"
                    f"<b>‚îú‚û§üí∏ Gi√° hi·ªán t·∫°i:</b> {gia_hien_tai_vnd:,.0f}\n"
                    f"<b>‚îú‚û§‚è≥ Gi√° tr∆∞·ªõc ƒë√≥:</b> {gia_truoc_do_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üìà Gi√° tƒÉng/gi·∫£m:</b> {gia_thay_doi_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üîé Ph·∫ßn trƒÉm tƒÉng/gi·∫£m:</b> {phan_tram_gia_thay_doi_vnd:.2f}%\n"
                    f"<b>‚îú‚û§üîì Gi√° m·ªü c·ª≠a:</b> {gia_mo_cua_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üõ°Ô∏è Gi√° ƒë√≥ng c·ª≠a:</b> {gia_dong_cua_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üìå Gi√° cao nh·∫•t:</b> {gia_cao_nhat_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üìå Gi√° th·∫•p nh·∫•t:</b> {gia_thap_nhat_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üìå Gi√° trung b√¨nh:</b> {gia_trung_binh_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üõí Gi√° mua:</b> {gia_mua_vnd:,.0f}\n"
                    f"<b>‚îú‚û§üõçÔ∏è Gi√° b√°n:</b> {gia_ban_vnd:,.0f}\n"
                    f"<b>‚îú‚û§‚öñÔ∏è Kh·ªëi l∆∞·ª£ng giao d·ªãch:</b> {khoi_luong_giao_dich_vnd:,.0f}\n"
                    f"<b>‚îú‚û§‚öñÔ∏è Kh·ªëi l∆∞·ª£ng t·ªâ gi√°:</b> {khoi_luong_ti_gia_vnd:,.0f}\n"
                    f"<b>‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>\n"
                    f"<b>‚îú‚û§üìé TP/SL:</b> [<u>{nguong_chot_loi:,.2f} - {nguong_chot_lo:,.2f}</u>]\n"
                    f"<b>‚îú‚û§üìé TP VND:</b> [<u>{nguong_chot_loi_vnd:,.2f}</u>]\n"
                    f"<b>‚îú‚û§üìé SL VND:</b> [<u>{nguong_chot_lo_vnd:,.2f}</u>]\n"
                    f"<b>‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚≠ì</b>\n"
                )
            if gia_hien_tai > nguong_chot_loi and not da_chot_loi:
                noi_dung_chot_loi = ( 
                    f"<b>‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚≠ì</b>\n"
                    f"<b>‚îú‚û§üìé ƒê√£ ch·ªët l·ªùi [TP]</b>\n"
                    f"<b>‚îú‚û§ Th·ªùi gian:</b> {thoi_gian}\n"
                    f"<b>‚îú‚û§ Gi√° ch·ªët l·ªùi:</b> [<u>{nguong_chot_loi:,.6f}</u>]\n"
                    f"<b>‚îú‚û§ Gi√° l√∫c ch·ªët l·ªùi:</b> [<u>{gia_hien_tai:,.6f}</u>]\n"
                    f"<b>‚îú‚û§ Quy ƒë·ªïi VNƒê</b>\n"
                    f"<b>‚îú‚û§ Gi√° ch·ªët l·ªùi:</b> {nguong_chot_loi_vnd:,.2f}\n"
                    f"<b>‚îú‚û§ Gi√° l√∫c ch·ªët l·ªùi:</b> {gia_hien_tai_vnd:,.2f}\n"
                    f"<b>‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>\n"
                )
                bot.send_message(message.chat.id, noi_dung_chot_loi, parse_mode = "HTML")
                da_chot_loi = True  # ƒê√°nh d·∫•u ƒë√£ g·ª≠i th√¥ng b√°o ch·ªët l·ªùi
            elif gia_hien_tai < nguong_chot_lo and not da_chot_lo:
                noi_dung_chot_lo = (
                    f"<b>‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚≠ì</b>\n"
                    f"<b>‚îú‚û§üìé ƒê√£ ch·ªët l·ªó [SL]</b>\n"
                    f"<b>‚îú‚û§ Th·ªùi gian:</b> {thoi_gian}\n"
                    f"<b>‚îú‚û§ Gi√° ch·ªët l·ªó:</b> [<u>{nguong_chot_lo:,.6f}</u>]\n"
                    f"<b>‚îú‚û§ Gi√° l√∫c ch·ªët l·ªó:</b> [<u>{gia_hien_tai:,.6f}</u>]\n"
                    f"<b>‚îú‚û§ Quy ƒë·ªïi VNƒê</b>\n"
                    f"<b>‚îú‚û§ Gi√° ch·ªët l·ªó:</b> {nguong_chot_lo_vnd:,.2f}\n"
                    f"<b>‚îú‚û§ Gi√° l√∫c ch·ªët l·ªó:</b> {gia_hien_tai_vnd:,.2f}\n"
                    f"<b>‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>\n"
                )
                bot.send_message(message.chat.id, noi_dung_chot_lo, parse_mode = "HTML")
                da_chot_lo = True  # ƒê√°nh d·∫•u ƒë√£ g·ª≠i th√¥ng b√°o ch·ªët l·ªùi
            if gia_hien_tai > gia_trung_binh_gan_nhat:
                noi_dung += f"\n<b>Gi√° tƒÉng n√™n mua {ten_crypto.replace('USDT', '')} l√∫c {thoi_gian}</b>"
            elif gia_hien_tai <= gia_trung_binh_gan_nhat:
                noi_dung += f"\n<b>Gi√° gi·∫£m n√™n b√°n {ten_crypto.replace('USDT', '')} l√∫c {thoi_gian}</b>"
            if noi_dung != current_content:
                bot.edit_message_text(chat_id=message.chat.id, message_id=msg.message_id, text=noi_dung, parse_mode="HTML")
                current_content = noi_dung    
            gia_truoc_do = gia_hien_tai
            gia_truoc_do_vnd = gia_hien_tai_vnd
            #print(f"‚û§ L·∫•y d·ªØ li·ªáu {ten_crypto.replace('USDT', '')} - {ngay_thoi_gian} th√†nh c√¥ng\n")
            time.sleep(3)
    except Exception as e:
        trang_thai_lenh['dang_chay'] = False
        bot.send_message(message.chat.id, f"<b>ƒê√£ x·∫£y ra l·ªói {e} !</b>", parse_mode = "HTML")

# H√†m l·∫•y gi√° trong qu√° kh·ª©
@bot.message_handler(commands=['gpi'])
def lay_gia_trong_khoang_thoi_gian(message):
    try:
        danh_sach = lay_danh_sach_crypto()
        nhap_thong_tin = message.text.split()
        if len(nhap_thong_tin) != 3:
            bot.send_message(message.chat.id, "<b>Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng: /gpi [t√™n coin] [kho·∫£ng th·ªùi gian l·∫•y data (m)]</b>", parse_mode = "HTML")
            return 
        ten_crypto = nhap_thong_tin[1].upper()
        khoang_thoi_gian = int(nhap_thong_tin[2]) 
        if ten_crypto not in danh_sach:
            bot.send_message(message.chat.id, "<b>ƒê·ªìng crypto kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i</b>", parse_mode = "HTML")
            return 
        if khoang_thoi_gian < 1 :
            bot.send_message(message.chat.id, "<b>Kho·∫£ng th·ªùi gian kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i</b>", parse_mode = "HTML")    
            return 
        thoi_gian_hien_tai = datetime.now()
        khoang_thoi_gian_muon_lay = khoang_thoi_gian 
        thoi_gian_muon_lay = thoi_gian_hien_tai - timedelta(minutes=khoang_thoi_gian_muon_lay)
        timestamp_thoi_gian_muon_lay = int(thoi_gian_muon_lay.timestamp() * 1000)
        timestamp_hien_tai = int(thoi_gian_hien_tai.timestamp() * 1000)
        datas = lay_thong_tin_gioi_han_crypto(ten_crypto, timestamp_thoi_gian_muon_lay, timestamp_hien_tai)
        if datas:
            all_noi_dung = ""
            for data in datas:
                thoi_gian = datetime.fromtimestamp(data[0] / 1000)  
                gia_mo_cua = data[1]
                gia_dong_cua = data[4]  
                gia_cao_nhat = data[2]
                gia_thap_nhat = data[3]
                khoi_luong = data[5]
                noi_dung = {
                        "Th·ªùi gian": thoi_gian.strftime("%Y-%m-%d %H:%M:%S"), 
                        "Gi√° m·ªü c·ª≠a": gia_mo_cua,
                        "Gi√° ƒë√≥ng c·ª≠a": gia_dong_cua,
                        "Gi√° cao nh·∫•t": gia_cao_nhat,
                        "Gi√° th·∫•p nh·∫•t": gia_thap_nhat,
                        "Kh·ªëi l∆∞·ª£ng": khoi_luong
                }
                all_noi_dung += json.dumps(noi_dung, indent=4, ensure_ascii=False) + "\n"
            if len(all_noi_dung) < 4096:
                unique_id = str(message.chat.id) + "_" + str(datetime.now().timestamp())
                data_storage[unique_id] = {
                    "ten_crypto": ten_crypto,
                    "khoang_thoi_gian": khoang_thoi_gian,
                    "all_noi_dung": all_noi_dung
                }
                nut_ghi_vao_file = telebot.types.InlineKeyboardButton("üìù Ghi n·ªôi dung v√†o file", callback_data=f"gvf:{unique_id}")
                keyboard = telebot.types.InlineKeyboardMarkup()
                keyboard.row(nut_ghi_vao_file)
                #bot.send_message(message.chat.id, f"<pre>Gi√° c·ªßa {ten_crypto.replace('USDT', '')} trong {khoang_thoi_gian} ph√∫t ƒë·ªï l·∫°i\n\n{all_noi_dung}</pre>", parse_mode="HTML", reply_markup=keyboard)
                bot.send_message(message.chat.id, f"```json\nGi√° c·ªßa {ten_crypto.replace('USDT', '')} trong {khoang_thoi_gian} ph√∫t ƒë·ªï l·∫°i\n\n{all_noi_dung}```", parse_mode="MarkdownV2", reply_markup=keyboard)
            else:
                ghi_noi_dung_vao_file(ten_crypto, khoang_thoi_gian, all_noi_dung, message)
        else: 
            bot.send_message(message.chat.id, f"<b>Kh√¥ng c√≥ d·ªØ li·ªáu {khoang_thoi_gian} ph√∫t tr∆∞·ªõc</b>", parse_mode = "HTML")    
    except Exception as e:
        bot.send_message(message.chat.id, f"<b>ƒê√£ x·∫£y ra l·ªói {e} !</b>", parse_mode = "HTML")

# H√†m ghi n·ªôi dung v√†o file         
def ghi_noi_dung_vao_file(ten_crypto, khoang_thoi_gian, all_noi_dung, message):
    file_path_crypto = f"/sdcard/download/codingpython/{ten_crypto}-{khoang_thoi_gian}.txt"
    try:
        file_exists = os.path.isfile(file_path_crypto)
        with open(file_path_crypto, "a", encoding="utf-8") as file:
            if not file_exists:
                file.write(f"Gi√° c·ªßa {ten_crypto.replace('USDT', '')} trong {khoang_thoi_gian} ph√∫t ƒë·ªï l·∫°i\n\n")
                file.write(all_noi_dung + "\n")
        with open(file_path_crypto, "rb") as file:
            bot.send_document(message.chat.id, file, caption = "Ho√†n th√†nh g·ª≠i file !")     
        os.remove(file_path_crypto)    
    except Exception as e:
        bot.send_message(message.chat.id, f"<b>ƒê√£ x·∫£y ra l·ªói {e} !</b>", parse_mode = "HTML")
    
# H√†m tr·∫£ l·ªùi ngo·∫°i l·ªá     
@bot.message_handler(func=lambda message: True)
@bot.message_handler(content_types=['sticker','photo','video','document'])    
def tra_loi_ngoai_le(message):
    huong_dan_su_dung = telebot.types.InlineKeyboardButton("üìù H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng", callback_data="hdsd")
    keyboard = telebot.types.InlineKeyboardMarkup()
    keyboard.row(huong_dan_su_dung)
    bot.send_message(message.chat.id, f"<b>‚ùå Sai l·ªánh. Vui l√≤ng xem l·∫°i</b>", parse_mode = "HTML")
    
bot.infinity_polling()